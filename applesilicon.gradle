// script for updating lwlgl in old forge dev environments that dont nativly work with apple silicon 
// LICENSE : Public Domain, https://creativecommons.org/publicdomain/zero/1.0
// AUTHOR  : LukeGrahamLandry#6888
// README  : https://moddingtutorials.org/m1
// NOTE    : you MUST set mc_version in your gradle.properties file
//           (you probably only need this script on 1.16.5)

import java.nio.charset.StandardCharsets
import java.nio.file.Files

if (System.getProperty("os.arch").equals("aarch64") && System.getProperty("os.name").equals("Mac OS X")){
    project.ext.lwjglVersion = "3.3.1"
    project.ext.lwjglNatives = "natives-macos-arm64"

    configurations.all {
        resolutionStrategy {
            force "org.lwjgl:lwjgl:${lwjglVersion}"
            force "org.lwjgl:lwjgl-openal:${lwjglVersion}"
            force "org.lwjgl:lwjgl-opengl:${lwjglVersion}"
            force "org.lwjgl:lwjgl-jemalloc:${lwjglVersion}"
            force "org.lwjgl:lwjgl-glfw:${lwjglVersion}"
            force "org.lwjgl:lwjgl-stb:${lwjglVersion}"
            force "org.lwjgl:lwjgl-tinyfd:${lwjglVersion}"
        }
    }

    logger.error("Apple Silicon for MC version ${project.mc_version}")

    String path = "caches/forge_gradle/mcp_repo/net/minecraft/client/${project.mc_version}/client-${project.mc_version}.pom"
    File cache = new File(project.getGradle().getGradleUserHomeDir(), path)

    if (cache.exists()) {
        List<String> lines = Files.readAllLines(cache.toPath(), StandardCharsets.UTF_8);

        FileWriter writer = new FileWriter(cache);

        for (String line : lines){
            if (!line.contains("arm")) line = line.replaceAll("natives-macos", "natives-macos-arm64") + "\n"
            writer.append(line)
        }
        writer.close();
    }
}